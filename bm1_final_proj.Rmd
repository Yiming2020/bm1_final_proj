---
title: "BM1 final project"
output: github_document
---

```{r setup, include = FALSE}
library(tidyverse)
rm(list = ls())
library(arsenal)
library(dplyr)
library(ggplot2)
library(HH)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

```{r, echo = F, message = FALSE, warning=FALSE}
# Data input
crimes<-read.csv("HateCrimes.csv") %>% 
  drop_na()
# Data format transformation
crimes$unemployment<- as.factor(crimes$unemployment)
crimes$urbanization<- as.factor(crimes$urbanization)
crimes$hate_crimes_per_100k_splc<-as.numeric(crimes$hate_crimes_per_100k_splc)
str(crimes)
```

## Descriptive statistics+Graphs
```{r, echo = F, message = FALSE, warning=FALSE}
# Descriptive Characteristics of study sample
labels1 <- list(hate_crimes_per_100k_splc = "Hate crime rate per 100k population", unemployment = "Level of state unemployment", urbanization="Level of state urbanization", median_household_income="Median household income per state",perc_population_with_high_school_degree="Percentage of adults (>25 yrs) with a high school degree",perc_non_citizen="Percentage of population that are not US citizens",gini_index="Gini index",perc_non_white="Percentage of population that are non-white")

controls1 <- tableby.control(total = T,test=F, numeric.stats = c("meansd", "median", "iqr","range", "Nmiss2"),cat.stats = c("countpct", "Nmiss2"),stats.labels = list(meansd = "Mean/SD",median = "Median",iqr="IQR",range = "Min - Max",Nmiss2 = "Missing",countpct = "N (%)"),digits = 2L,digits.count = 0L)
tb1<-tableby(~hate_crimes_per_100k_splc+unemployment+urbanization+median_household_income+perc_population_with_high_school_degree+perc_non_citizen+gini_index+perc_non_white,data=crimes,control = controls1)
summary(tb1, title = "Descriptive Characteristics of Study Sample, Hate Crimes Occurring in the United States (By State)", labelTranslations = labels1, text=T)

# Histogram of the outcome distribution
mytheme <- theme_bw() + theme(plot.title=element_text(hjust=0.5),axis.title=element_text(size=rel(1)),axis.text=element_text(size=rel(1)),legend.position = "top")
ggplot(data=crimes,aes(x=hate_crimes_per_100k_splc))+
geom_histogram(fill="lightblue",color="darkblue",linetype="dashed",alpha=0.5) +
labs(title="Histogram of Hate Crimes Rate Per 100k Population in United States",x="Hate Crimes Rate (Per 100 K Population)", y = "Count")+mytheme
## District of columbia might be a outlier
```

## Varible Selection
```{r, echo = F, message = FALSE, warning=FALSE}
# Correlation matrix
library("corrplot")
matrix1<-cor(crimes[,-c(1:3)],use="complete.obs")
matrix1 %>% 
    corrplot::corrplot(
    method = "square",
    type = "lower",
    addCoef.col = "black", 
    diag = T,
    tl.cex = 0.5
  )
round(matrix1,2) # Cor(non-white and non-citizen): 0.75; cor(income and > high school degree):0.65

```

median_household_income and perc_population_with_high_school_degree may highly correlated.
perc_non_white and perc_non_cizen may highly correlated.




## Model building
```{r}
# Varibale Selection- Stepwise
res1 <- lm(hate_crimes_per_100k_splc ~. -state, data=crimes)

summary(res1)
```

## box cox

```{r}
boxcox(res1)
```

lamda =0, get maximum likelihood, so the outcome should be applied to log transformation.

```{r}
crime_log = 
  crimes %>%
  mutate(ln_hate_crime_outcome = log(hate_crimes_per_100k_splc, base = exp(1))) 
  
fit2 = 
  lm(ln_hate_crime_outcome ~ . -state -hate_crimes_per_100k_splc , data = crime_log)
summary(fit2)

```

## Identify Collinearity
```{r}
# Calculate the variance inflation factor (VIF)
vif(fit2)
```
no VIF higher than 5, nothing should be remove because of collinearity

## check for outliers

remove 7 and 9
```{r}

# Measures of influence:
# Gives DFFITS, Cook's Distance, Hat diagonal elements, and others.

influence.measures(fit2)

# Look at the Cook's distance lines and notice obs 36 and 29 as potential Y outliers/influential points

par(mfrow=c(2,2))
plot(fit2)


# Remove observations 36 and 29
crime_log_rm_36_29_9<-crime_log[c(-36,-29, -9),]
mult.fit_no36_29_9<- lm(ln_hate_crime_outcome ~ . -state -hate_crimes_per_100k_splc, data = crime_log_rm_36_29_9)

summary(mult.fit_no36_29_9)

influence.measures(mult.fit_no36_29_9)

par(mfrow=c(2,2))
plot(mult.fit_no36_29_9)
```

